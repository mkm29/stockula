[databases]
; Production database configuration with optimized pool settings
stockula = host=timescaledb port=5432 dbname=stockula user=stockula password=SuperSecret12 pool_size=100 max_db_connections=200
; Read-only connection for analytics (optional)
stockula_ro = host=timescaledb port=5432 dbname=stockula user=stockula password=SuperSecret12 pool_size=50 max_db_connections=100

[pgbouncer]
; Connection pooling mode
; session: one connection per client session
; transaction: one connection per transaction
; statement: most aggressive, one connection per statement
pool_mode = transaction

; Listen on all addresses
listen_addr = 0.0.0.0
listen_port = 5432

; Authentication settings
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

; Connection limits - Production optimized for high concurrency
max_client_conn = 2000
default_pool_size = 100
min_pool_size = 25
reserve_pool_size = 25
reserve_pool_timeout = 3
max_db_connections = 200
max_user_connections = 150

; Server connection settings - Optimized for production
server_lifetime = 7200
server_idle_timeout = 300
server_connect_timeout = 10
server_login_retry = 5
server_round_robin = 1
server_fast_close = 1

; Query settings - Production timeouts
query_timeout = 300
query_wait_timeout = 60
cancel_wait_timeout = 5
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

; Client connection settings
client_idle_timeout = 0
client_login_timeout = 60

; DNS settings
dns_max_ttl = 3600
dns_nxdomain_ttl = 3600
dns_zone_check_period = 0

; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

; Admin settings
admin_users = stockula
stats_users = stockula

; SSL settings (disabled for internal communication)
server_tls_sslmode = disable
client_tls_sslmode = disable

; Memory settings
pkt_buf = 8192
max_packet_size = 2147483647
sbuf_loopcnt = 5

; Performance tuning - Production optimized
server_reset_query = DISCARD ALL
server_reset_query_always = 0
server_check_query = SELECT 1
server_check_delay = 10
max_prepared_statements = 0
disable_pqexec = 0
confdir = /etc/pgbouncer
pidfile = /var/run/pgbouncer/pgbouncer.pid

; Application name
application_name_add_host = 1

; Ignore startup parameters
ignore_startup_parameters = extra_float_digits,search_path
